{% extends "common/base_sidebar.html" %}
{% load static %}
{% block page_content %}

<div class="card">
  <div class="card-header">
    <div class="header-title h3 pl-4"><span class="text-primary-rainbow">Create Video</span> &nbsp;&nbsp;</div>
  </div>
  <div class="card-body">
    <div class="row-cols-xl-4">
      <div class="card">
        <div style="position: relative;">
          <img class="card-img-top" src="{% static selected_theme.url %}">
        </div>
      <div class="card-body shadow-sm">
        <div class="row p-1">
          <div class="col">
            <p style="line-height: .60rem;">
              <h4 class="mb-2">{{ selected_theme.name }}</h4>
            </p>
            <span class="tiny text-body-secondary">{{ selected_theme.description }}</span>

          </div>
  
        </div>
      </div>
      </div>
    </div>

    <form id="topic-form">
      {% csrf_token %}
      <div class="mb-3">
        <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
          <!-- <input type="checkbox" class="btn-check" id="long-video" name="long-vide" autocomplete="off">
          <label class="btn btn-outline-primary" for="long-video">Long</label>   -->
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="long-video" style="width: 3rem; height: 1.5rem; border-radius: 1.5rem;">
            <label class="form-check-label" for="long-video" style="font-size: 1.25rem; padding-left: 0.5rem;">Long Video</label>
          </div>      
          <div class="btn-group" role="group">
            <input type="hidden" id="selectedtheme" name="selectedtheme" value="{{selected_theme.theme_id}}">
          </div>
        </div>
        <div class="mt-4"></div> <!-- Add spacing here -->
        <input id="topic" name="topic" class="form-control me-2 border-primary" type="text" placeholder="What's on your mind?">
        <div class="mt-4"></div> <!-- Add spacing here -->
        <button type="submit" class="btn btn-primary form-control">Submit</button>
      </div>
    </form>
  </div>
</div>
<div class="card" id="response-header" style="display: none;">
  <div class="card-header">
    <div class="header-title h3 pl-4"><span class="text-primary-rainbow">Digital Workers on task</span> &nbsp;&nbsp;
    </div>
  </div>
  <div class="card-body">
    <div class="row align-items-stretch">
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/searcher.png' %}" class="avatar-img rounded-circle"
                    alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1 text-truncate">Researcher</h4>
                <span class='tiny'>Primary responsible to research online and gether content</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/creater.png'%}" class="avatar-img rounded-circle" alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1">Content Craftsman</h4>
                <span class='tiny'>Primary responsible to curating and crafting engaging content</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/editor.png' %}" class="avatar-img rounded-circle" alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1">Video Illustrator</h4>
                <span class='tiny'>Primary responsible to produce audio and video contents</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/artist.png' %}" class="avatar-img rounded-circle" alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1">Art Illustrator</h4>
                <span class='tiny'>Primary responsible to design visual content for Articles</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/publisher.png' %}" class="avatar-img rounded-circle"
                    alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1">Publisher</h4>
                <span class='tiny'>Primary responsible to oversee the final steps of content distribution</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-lg-4 col-md-6 mb-3">
        <div class="card card-fill shadow-sm">
          <div class="card-body px-2">
            <div class="row align-items-center">
              <div class="col-auto pr-1">
                <a class="avatar avatar-lg">
                  <img src="{% static 'assets/img/social-avatar.png' %}" class="avatar-img rounded-circle"
                    alt="Avatar Image">
                </a>
              </div>
              <div class="col px-2">
                <h4 class="mb-1">Influencer</h4>
                <span class='tiny'>Primary responsible to engaging social media content</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="card" id="response-body" style="display: none;">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col-auto pr-1">
        <span class="text-primary-rainbow spinner-grow-sm" id="loading-btn-header">
          <div class="spinner-grow text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="spinner-grow text-info" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="spinner-grow text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </span> &nbsp;&nbsp;
      </div>
      <div class="col px-2">
        <h4 class="mb-1 text-primary-rainbow" id="displaytopic" value="">Influencer</h4>
      </div>
    </div>
  
  </div>
  <div class="card-body" id="msg"></div>
  <!-- <div class="card-footer">
    <div class="header-title h3 pl-4"><span class="text-primary-rainbow spinner-grow-sm" id="loading-btn-footer">
        <div class="spinner-grow text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="spinner-grow text-info" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="spinner-grow text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </span> &nbsp;&nbsp;</div>
  </div> -->

</div>


{% endblock %}

{% block scripts %}
<script>

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  $(document).on('submit', '#topic-form', function (e) {
    e.preventDefault();
    $('#msg').empty();
    $('#response-header').hide();
    $('#response-body').hide();

    topic = $('#topic').val();

    $('#displaytopic').text(topic);
    long_video = $('#long-video').is(':checked');

    console.log('long_video', long_video);

    var theme = $('#selectedtheme').val()
    console.log('theme', theme);
    if (topic === null || topic === '') { return; }
    if (theme === null || theme === '') { return; }
 
    $('#submit-button').hide();
    $.ajax({
      type: 'POST',
      url: "{% url 'create_video' %}",
      data: {
        topic: $('#topic').val(),
        long_video: $('#long_video').is(':checked'),
        theme: theme,
        csrfmidddlewaretoken: $('input[name=csrfmidddlewaretoken]').val()
      },
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      success: function (response) {
        $('#topic').val('');
        $('#checkbox1').prop('checked', false);
        $('#checkbox2').prop('checked', false);
        $('#theme').val('Theme');

        answer = response.message;
        console.log('response', response.id, response.message);
        let publisher_url = `ws://${window.location.host}/ws/video_retrieve/`;
        const socket = new WebSocket(publisher_url);
        socket.onopen = function (event) {
          console.log('WebSocket connection established.');
          socket.send(JSON.stringify({
            'command': 'subscribe',
            'channel': response.id
          }));
        };
        $('#response-header').show();
        $('#response-body').show();
        // When a message is received from the server
        socket.onmessage = function (event) {
          const message = JSON.parse(event.data);
          console.log('Message received:', message.message.profile);
          profile = message.message.profile.profile;
          task = message.message.profile.task;
          data = message.message.message;
          url = message.message.profile.url;
          if (data == 'DONE') {
              $('#loading-btn-header').empty();
              $('#loading-btn-footer').empty();
          } else if (data !== undefined && data !== null) { // Check if data is not undefined or null
              $('#msg').html(`
                  <div class="row align-items-center">
                      <div class="card">
                          <div class="card-body">
                              <div class="row align-items-center">
                                  <div class="col-xl-1 col-lg-2">
                                      <a class="avatar avatar-lg">
                                          <img src="{% static '.' %}${url}" class="avatar-img rounded-circle" alt="Avatar Image">
                                      </a>
                                  </div>
                                  <div class="col-xl-2 col-lg-2">
                                      <h4 class="mb-1">${profile}</h4>
                                      <p class="small text-body-secondary mb-1">${task}</p>
                                  </div>
                                  <div class="col-xl-9 col-lg-8">
                                      <p class="small text-body-secondary mb-1">${data}</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>`);
          }

      };

      },
      error: function (err) {
        console.log('error', err);
      }
    })
  })



</script>
{% endblock %}